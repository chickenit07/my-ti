<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Threat Intelligence Platform</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='resources/logo.svg') }}">
    <script>
        window.APP_URLS = { addTokens: '{{ url_for("user.add_tokens") }}', saveResults: '{{ url_for("user.save_results_endpoint") }}' };
    </script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/search.css') }}">
</head>
<body data-theme="dark">
    <div id="thinking-overlay" aria-hidden="true">
        <div class="thinking-box">
            <div class="thinking-dots" aria-label="Thinking">
                <span></span><span></span><span></span>
            </div>
            <div>AI is thinkingâ€¦</div>
        </div>
    </div>
    <div class="container-fluid px-0">
        <!-- Professional Header -->
        <div class="search-header">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <img src="{{ url_for('static', filename='resources/logo.svg') }}" alt="logo" class="site-logo">
                    <h3 class="header-title"><i class="fas fa-search me-2"></i>Credential Search</h3>
                    {% if user_role == 'guest' %}{% endif %}
                    {% if user_role == 'admin' %}
                    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary btn-sm me-2">
                        <i class="fas fa-tools me-2"></i>Admin
                    </a>
                    {% endif %}
                    <a href="{{ url_for('user.saved_page') }}" class="btn btn-secondary btn-sm me-2">
                        <i class="fas fa-bookmark me-2"></i>My Saved Records
                    </a>
                </div>
                <div class="user-info">
                    {% if user_role == 'guest' %}
                    <div class="token-info me-2" title="Earn tokens" id="tokenInfo">
                        <i class="fas fa-coins me-2"></i>
                        <span class="token-count">{{ tokens }} tokens</span>
                        <a href="{{ url_for('user.tokens_page') }}" class="token-plus ms-2" title="Earn tokens">
                            <i class="fas fa-plus"></i>
                        </a>
                    </div>
                    {% endif %}
                    <div class="user-badge">
                        <i class="fas fa-user me-1"></i>{{ username }} ({{ user_role.title() }})
                    </div>
                    <a href="{{ url_for('user.logout') }}" class="btn btn-danger btn-sm ms-2">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <form method="POST" action="{{ url_for('user.search') }}" class="search-form">

            <div class="row gy-3 gx-3 align-items-end">
                <div class="col-md-4">
                    <label for="domain" class="form-label">Domain</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-globe"></i></span>
                        <input type="text" name="domain" id="domain" class="form-control" value="{{ request.form.get('domain', '') }}" placeholder="Enter domain">
                    </div>
                </div>

                <div class="col-md-4">
                    <label for="username" class="form-label">Username</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-user"></i></span>
                        <input type="text" name="username" id="username" class="form-control" value="{{ request.form.get('username', '') }}" placeholder="Enter username">
                    </div>
                </div>

                <div class="col-md-1">
                    <label for="line" class="form-label">Search Limit</label>
                    {% if user_role == 'admin' %}
                        <input type="number" name="line" id="line" class="form-control" value="{{ request.form.get('line', '2000') }}" min="1" max="10000" placeholder="Max 10,000">
                    {% else %}
                        <input type="number" name="line" id="line" class="form-control" value="{{ request.form.get('line', '50') }}" min="1" max="2000" placeholder="Max 2,000">
                    {% endif %}
                </div>
                
                <!-- Hidden page field for pagination -->
                <input type="hidden" name="page" id="page" value="{{ current_page }}">

                <div class="col-md-1">
                    <label for="type" class="form-label">Search Type</label>
                    <select name="type" id="type" class="form-select">
                        <option value="" {% if request.form.get('type', '') == '' %}selected{% endif %}>Any</option>
                        <option value="exact" {% if request.form.get('type', '') == 'exact' %}selected{% endif %}>Exact</option>
                    </select>
                </div>

                <div class="col-md-2 text-end">
                    <button type="submit" class="btn btn-primary" {% if user_role == 'guest' and tokens <= 0 %}disabled{% endif %}>
                        <i class="fas fa-search me-2"></i>Search
                        {% if user_role == 'guest' %}{% endif %}
                    </button>
                </div>
            </div>
        </form>

        <!-- Flash Messages converted to toast notifications (unified) -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        {% for category, message in messages %}
                        showToastMessage('{{ message|e }}', {% if category == 'error' %}false{% else %}true{% endif %});
                        {% endfor %}
                    });
                </script>
            {% endif %}
        {% endwith %}

        <!-- Results Table -->
        <div class="results-table">
            <div class="table-responsive">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    {% if total_results > results_per_page %}
                    <!-- Top-left pagination controls -->
                    <nav aria-label="Search results pagination">
                        <ul class="pagination pagination-sm mb-0">
                            {% if current_page > 1 %}
                                <li class="page-item">
                                    <button type="button" class="page-link" onclick="goToPage(1)" title="First page">
                                        <i class="fas fa-angle-double-left"></i>
                                    </button>
                                </li>
                                <li class="page-item">
                                    <button type="button" class="page-link" onclick="goToPage({{ current_page - 1 }})" title="Previous page">
                                        <i class="fas fa-angle-left"></i>
                                    </button>
                                </li>
                            {% endif %}
                            
                            {% set start_page = [current_page - 2, 1] | max %}
                            {% set end_page = [current_page + 2, total_pages] | min %}
                            
                            {% for page_num in range(start_page, end_page + 1) %}
                                <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                    <button type="button" class="page-link" onclick="goToPage({{ page_num }})" title="Go to page {{ page_num }}">{{ page_num }}</button>
                                </li>
                            {% endfor %}
                            
                            {% if current_page < total_pages %}
                                <li class="page-item">
                                    <button type="button" class="page-link" onclick="goToPage({{ current_page + 1 }})" title="Next page">
                                        <i class="fas fa-angle-right"></i>
                                    </button>
                                </li>
                                <li class="page-item">
                                    <button type="button" class="page-link" onclick="goToPage({{ total_pages }})" title="Last page">
                                        <i class="fas fa-angle-double-right"></i>
                                    </button>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% if user_role == 'admin' %}
                    <form method="post" class="d-flex align-items-center gap-2 ms-2" onsubmit="event.preventDefault(); document.getElementById('page').value = {{ current_page }}; this.submit();">
                        <label for="results_per_page" class="form-label mb-0 me-2">Results/Page</label>
                        <input type="number" name="results_per_page" id="results_per_page" class="form-control form-control-sm" value="{{ request.form.get('results_per_page', '100') }}" min="10" max="1000" style="width: 110px;">
                        <button type="submit" class="btn btn-outline-primary btn-sm">Apply</button>
                    </form>
                    {% endif %}
                    {% else %}
                    <div></div>
                    {% endif %}
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="copyAllDomains()" type="button">
                            <i class="fas fa-globe me-2"></i>Copy All Domains
                        </button>
                        <button class="btn btn-outline-primary" onclick="copyAllUsernames()" type="button">
                            <i class="fas fa-users me-2"></i>Copy All Usernames
                        </button>
                        <button class="btn btn-outline-primary" onclick="copyAllPasswords()" type="button">
                            <i class="fas fa-key me-2"></i>Copy All Passwords
                        </button>
                        <button class="btn btn-success" onclick="saveSelected()" type="button">
                            <i class="fas fa-bookmark me-2"></i>Save Record
                        </button>
                    </div>
                </div>
                <table class="table">
                    <colgroup>
                        <col style="width: 3%">
                        <col style="width: 8%">
                        <col style="width: 15%">
                        <col style="width: 20%">
                        <col style="width: 20%">
                        <col style="width: 2%">
                        <col style="width: 32%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th style="width: 3%">#</th>
                            <th style="width: 8%">Timestamp</th>
                            <th style="width: 15%">Domain</th>
                            <th style="width: 20%">Username</th>
                            <th style="width: 20%">Password</th>
                            <th style="width: 2%">Select</th>
                            <th style="width: 32%">Note</th>
                        </tr>
                    </thead>
                    <tbody> 
                        {% if hits %}
                            {% for hit in hits %}
                            <tr>
                                <td>{{ ((current_page - 1) * results_per_page) + loop.index }}</td>
                                <td>{{ hit.t }}</td>
                                <td>
                                    <a href="http://{{ hit.d }}" target="_blank" class="domain-link">
                                        {{ hit.d }}
                                    </a>
                                </td>
                                <td>   
                                    <div class="d-flex align-items-center copyable-box">
                                        <span class="me-2 flex-grow-1">{{ hit.u }}</span>
                                        <button class="copy-btn" title="Copy username" onclick="event.stopPropagation(); copyToClipboard(this.previousElementSibling.textContent.trim(), this.previousElementSibling);">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center copyable-box">
                                        <span class="me-2 flex-grow-1">{{ hit.p }}</span>
                                        <button class="copy-btn" title="Copy password" onclick="event.stopPropagation(); copyToClipboard(this.previousElementSibling.textContent.trim(), this.previousElementSibling);">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </td>
                                <td>
                                    <div class="form-check d-flex justify-content-center align-items-center" style="min-height: 44px;">
                                        <input type="checkbox" class="form-check-input" name="select_checkbox" value="{{ ((current_page - 1) * results_per_page) + loop.index }}" style="width: 1.25rem; height: 1.25rem;">
                                    </div>
                                </td>
                                <td>
                                    <textarea class="note-textarea" name="note" rows="1" placeholder="Add a note..." oninput="autoSelectCheckbox(this)"></textarea>
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="7" class="text-center py-4">
                                    <div class="empty-state">
                                        <i class="fas fa-search mb-2"></i>
                                        <p class="helper-text mb-0">Enter search criteria above to view credentials</p>
                                        {% if user_role == 'guest' and tokens <= 0 %}
                                            <p class="helper-text mt-2"><strong>You need tokens to search. Click Earn Token to get more.</strong></p>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
            
            <!-- Bottom Pagination Controls -->
            {% if total_results > results_per_page %}
            <div class="d-flex justify-content-between align-items-center p-3 border-top">
                <!-- Bottom-left pagination controls -->
                <nav aria-label="Search results pagination">
                    <ul class="pagination pagination-sm mb-0">
                        {% if current_page > 1 %}
                            <li class="page-item">
                                <button type="button" class="page-link" onclick="goToPage(1)" title="First page">
                                    <i class="fas fa-angle-double-left"></i>
                                </button>
                            </li>
                            <li class="page-item">
                                <button type="button" class="page-link" onclick="goToPage({{ current_page - 1 }})" title="Previous page">
                                    <i class="fas fa-angle-left"></i>
                                </button>
                            </li>
                        {% endif %}
                        
                        {% set start_page = [current_page - 2, 1] | max %}
                        {% set end_page = [current_page + 2, total_pages] | min %}
                        
                        {% for page_num in range(start_page, end_page + 1) %}
                            <li class="page-item {% if page_num == current_page %}active{% endif %}">
                                <button type="button" class="page-link" onclick="goToPage({{ page_num }})" title="Go to page {{ page_num }}">{{ page_num }}</button>
                            </li>
                        {% endfor %}
                        
                        {% if current_page < total_pages %}
                            <li class="page-item">
                                <button type="button" class="page-link" onclick="goToPage({{ current_page + 1 }})" title="Next page">
                                    <i class="fas fa-angle-right"></i>
                                </button>
                            </li>
                            <li class="page-item">
                                <button type="button" class="page-link" onclick="goToPage({{ total_pages }})" title="Last page">
                                    <i class="fas fa-angle-double-right"></i>
                                </button>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                
                <!-- Bottom-right result info -->
                <div class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Displaying {{ ((current_page - 1) * results_per_page) + 1 }} to {{ [current_page * results_per_page, total_results] | min }} of {{ "{:,}".format(total_results) }} results
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Saved searches moved to dedicated pages (/saved, /saved/<id>) -->
    </div>

    <!-- Toast Notification -->
    <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <i class="fas fa-check-circle me-2 text-success"></i>
            <strong class="me-auto" id="toast-title">Notice</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toast-body">
            Copied to clipboard!
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/search.js') }}"></script>
    <script>
        // goToPage function moved to head for early availability
        
        // Add event delegation for pagination buttons to ensure clicks work
        document.addEventListener('DOMContentLoaded', function() {
            // Use event delegation for pagination buttons
            document.addEventListener('click', function(e) {
                // Check if clicked element is a pagination button
                if (e.target.matches('.pagination .page-link') || e.target.closest('.pagination .page-link')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const button = e.target.matches('.pagination .page-link') ? e.target : e.target.closest('.pagination .page-link');
                    const pageNumber = parseInt(button.textContent.trim()) || button.getAttribute('data-page');
                    
                    if (pageNumber) {
                        console.log('Event delegation: clicking page', pageNumber);
                        goToPage(pageNumber);
                    }
                }
            });
            
            console.log('Event delegation set up for pagination');
        });
        
        // Initialize toast
        const toastEl = document.querySelector('.toast');
        const toast = new bootstrap.Toast(toastEl, { delay: 2500 });
        function showToastMessage(message, isSuccess = true) {
            const title = document.getElementById('toast-title');
            const body = document.getElementById('toast-body');
            const icon = toastEl.querySelector('.toast-header i');
            title.textContent = isSuccess ? 'Success' : 'Oops';
            icon.className = isSuccess ? 'fas fa-check-circle me-2 text-success' : 'fas fa-exclamation-triangle me-2 text-danger';
            body.textContent = message;
            toast.show();
        }
        function showToast() { showToastMessage('Copied to clipboard!', true); }
        async function addTokens(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData();
            formData.append('security_answer', form.security_answer.value);
            try {
                const response = await fetch('{{ url_for("user.add_tokens") }}', { method: 'POST', body: formData });
                const result = await response.json();
                if (result.success) {
                    document.querySelector('.token-info').innerHTML = `<i class=\"fas fa-coins me-2\"></i>${result.tokens} tokens`;
                    form.reset();
                    const searchBtn = document.querySelector('button[type=\"submit\"]');
                    if (searchBtn.disabled) searchBtn.disabled = false;
                    showToastMessage(result.message, true);
                } else {
                    showToastMessage(result.message, false);
                }
            } catch (error) { console.error('Error adding tokens:', error); showToastMessage('An error occurred while adding tokens.', false); }
        }
        function copyToClipboard(value, element) {
            document.querySelectorAll('.copyable-box.highlight').forEach(box => { box.classList.remove('highlight'); });
            var dummy = document.createElement("textarea"); document.body.appendChild(dummy); dummy.value = value; dummy.select(); document.execCommand("copy"); document.body.removeChild(dummy); showToast && showToast(); if (element) { element.classList.add('highlight'); }
        }
        function copyAllDomains() { document.querySelectorAll('.copyable-box.highlight').forEach(box => { box.classList.remove('highlight'); }); const rows = document.querySelectorAll('tbody tr'); const domains = []; rows.forEach(row => { const domainCell = row.querySelector('td:nth-child(3) .domain-link'); if (domainCell) { const domain = domainCell.textContent.trim(); domains.push(domain); const copyableBox = domainCell.closest('td'); if (copyableBox) { copyableBox.classList.add('highlight'); } } }); copyToClipboard(domains.join('\r\n')); }
        function copyAllUsernames() { document.querySelectorAll('.copyable-box.highlight').forEach(box => { box.classList.remove('highlight'); }); const rows = document.querySelectorAll('tbody tr'); const usernames = []; rows.forEach(row => { const usernameCell = row.querySelector('td:nth-child(4) .flex-grow-1'); if (usernameCell) { const username = usernameCell.textContent.trim(); usernames.push(username); const copyableBox = usernameCell.closest('.copyable-box'); if (copyableBox) { copyableBox.classList.add('highlight'); } } }); copyToClipboard(usernames.join('\r\n')); }
        function copyAllPasswords() { document.querySelectorAll('.copyable-box.highlight').forEach(box => { box.classList.remove('highlight'); }); const rows = document.querySelectorAll('tbody tr'); const passwords = []; rows.forEach(row => { const passwordCell = row.querySelector('td:nth-child(5) .flex-grow-1'); if (passwordCell) { const password = passwordCell.textContent.trim(); passwords.push(password); const copyableBox = passwordCell.closest('.copyable-box'); if (copyableBox) { copyableBox.classList.add('highlight'); } } }); copyToClipboard(passwords.join('\r\n')); }
        // Theme switching functionality
        function setTheme(theme) {
            // Set theme on both html and body elements to ensure compatibility
            document.documentElement.setAttribute('data-theme', theme);
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            
            console.log('Theme changed to:', theme);
            console.log('HTML data-theme:', document.documentElement.getAttribute('data-theme'));
            console.log('Body data-theme:', document.body.getAttribute('data-theme'));
            
            // Update active state
            document.querySelectorAll('.theme-switcher .theme-icon').forEach(icon => {
                icon.classList.remove('active');
            });
            
            // Find and activate the correct icon
            const activeIcon = document.querySelector(`.theme-switcher .theme-icon[data-theme="${theme}"]`);
            if (activeIcon) {
                activeIcon.classList.add('active');
            }
        }

        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'))
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) { return new bootstrap.Tooltip(tooltipTriggerEl) });
        document.querySelectorAll('input[name="select_checkbox"]').forEach(checkbox => { checkbox.addEventListener('change', function() { const row = this.closest('tr'); row.style.backgroundColor = this.checked ? 'rgba(52, 152, 219, 0.1)' : ''; }); });
        document.querySelectorAll('.note-textarea').forEach(textarea => { textarea.addEventListener('input', function() { this.style.height = 'auto'; this.style.height = (this.scrollHeight) + 'px'; }); });
        
        // Auto-select checkbox when textarea is edited
        function autoSelectCheckbox(textarea) {
            const row = textarea.closest('tr');
            const checkbox = row.querySelector('input[name="select_checkbox"]');
            if (checkbox && !checkbox.checked) {
                checkbox.checked = true;
                // Trigger the change event to update row highlighting
                checkbox.dispatchEvent(new Event('change'));
            }
        }

        // Load theme immediately to prevent flash
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body.setAttribute('data-theme', savedTheme);
            console.log('Theme loaded immediately:', savedTheme);
        })();

        // Consolidated DOMContentLoaded listener
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing all systems');
            
            // Initialize theme system
            const savedTheme = localStorage.getItem('theme') || 'dark';
            setTheme(savedTheme);
            
            // Add click event listeners to theme icons
            document.querySelectorAll('.theme-switcher .theme-icon').forEach(icon => {
                icon.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const theme = this.getAttribute('data-theme');
                    setTheme(theme);
                });
            });
            
            // Initialize copy buttons
            document.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const textElement = this.previousElementSibling;
                    const textToCopy = textElement.textContent.trim();
                    const copyableBox = this.closest('.copyable-box');
                    copyToClipboard(textToCopy, copyableBox);
                });
            });
        });

        async function saveSelected() {
            try {
                const rows = Array.from(document.querySelectorAll('tbody tr'));
                const items = [];
                rows.forEach((row) => {
                    const checkbox = row.querySelector('input[name="select_checkbox"]');
                    if (!checkbox || !checkbox.checked) return;
                    const t = row.querySelector('td:nth-child(2)')?.textContent.trim();
                    const d = row.querySelector('td:nth-child(3) .domain-link')?.textContent.trim();
                    const u = row.querySelector('td:nth-child(4) .flex-grow-1')?.textContent.trim();
                    const p = row.querySelector('td:nth-child(5) .flex-grow-1')?.textContent.trim();
                    const note = row.querySelector('textarea[name="note"]')?.value.trim() || '';
                    if (d && u && p) {
                        items.push({ t, d, u, p, note });
                    }
                });
                if (items.length === 0) {
                    showToastMessage('No selected rows to save.', false);
                    return;
                }
                const name = prompt('Enter a name for this saved search:');
                if (!name) { return; }
                const res = await fetch('{{ url_for("user.save_results_endpoint") }}', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, items })
                });
                const result = await res.json();
                if (result.success) {
                    showToastMessage(`Saved ${result.count} record(s) to \"${name}\".`, true);
                } else {
                    showToastMessage(result.message || 'Failed to save.', false);
                }
            } catch (e) {
                console.error('Failed to save', e);
                showToastMessage('Error saving records.', false);
            }
        }
    </script>

    <!-- Fixed Theme Switcher -->
    
</body>
</html>
